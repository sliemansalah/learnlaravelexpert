أهلاً بك! أنا هنا لمساعدتك في رحلة تعلم وإتقان إطار العمل لارافيل (Laravel)، والتركيز بشكل خاص على فهم العلاقات (Relationships) بين النماذج (Models) المختلفة [1].

سنتعلم معًا خطوة بخطوة، وسأوفر لك الدروس والأمثلة العملية والأسئلة والمشاريع المصغرة للتأكد من إتقانك للموضوع بشكل كامل.


خطة التعلم المقترحة:
الأساسيات: تثبيت لارافيل، المفاهيم الأساسية (MVC، المسارات، المتحكمات، الواجهات، الهجرات).
أساسيات Eloquent ORM: التعامل مع قواعد البيانات، النماذج، الاستعلامات الأساسية.
العلاقات (المحور الرئيسي):
الجزء الأول: علاقة رأس برأس (One-to-One).
الجزء الثاني: علاقة رأس بأطراف (One-to-Many).
الجزء الثالث: علاقة أطراف بأطراف (Many-to-Many).
الجزء الرابع: العلاقات التبادلية (Polymorphic Relationships).
الجزء الخامس: علاقات أصبحت علاقات (Has Many Through & Has One Through).
مشاريع وتحديات: تطبيق عملي لكل ما تعلمناه.
المرحلة الأولى: الأساسيات والإعداد
قبل أن نبدأ في العلاقات، يجب أن نتأكد من إعداد بيئة العمل وفهم كيفية عمل Eloquent ORM.
الدرس الأول: إعداد بيئة العمل وأساسيات Eloquent
الهدف: تجهيز مشروع لارافيل وفهم كيفية إنشاء النماذج والهجرات.
الخطوة 1: تثبيت لارافيل
تأكد من تثبيت PHP و Composer على جهازك. بعد ذلك، يمكنك إنشاء مشروع جديد باستخدام الأمر التالي في سطر الأوامر (Terminal/CMD):


composer create-project laravel/laravel school_project
cd school_project
php artisan serve



الخطوة 2: إنشاء نماذج وجداول (Models & Migrations)
في عالم العلاقات، نحتاج إلى كيانات (Entity) لربطها ببعضها البعض. لنبدأ بمثال بسيط: "مستخدم" و "منشور" (Users and Posts).
نستخدم أمر Artisan لإنشاء النموذج والهجرة معاً:



php artisan make:model User -m
php artisan make:model Post -m




User.php: هو النموذج (Model) الذي يمثل جدول users في قاعدة البيانات.
Post.php: هو النموذج الذي يمثل جدول posts في قاعدة البيانات.
ملفات الهجرة (Migrations) ستجدها في مجلد database/migrations.
الخطوة 3: تعريف الجداول في ملفات الهجرة
افتح ملف الهجرة الخاص بالـ posts (اسمه يحتوي على _create_posts_table.php) وأضف بداخله الحقول الضرورية، بما في ذلك مفتاح خارجي لربطه بالمستخدم [1]:



// database/migrations/..._create_posts_table.php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('posts', function (Blueprint $table) {
            $table->id();
            $table->string('title');
            $table->text('body');
            // هذا هو المفتاح الخارجي الذي سيربط المنشور بجدول المستخدمين
            $table->foreignId('user_id')->constrained()->onDelete('cascade');
            $table->timestamps();
        });
    }
    // ...
};



الخطوة 4: تشغيل الهجرة
نفّذ الأمر التالي لإنشاء الجداول في قاعدة البيانات:

php artisan migrate




المرحلة الثانية: العلاقات
الآن، وبعد أن أصبح لدينا جدولين مرتبطين بمفتاح خارجي (user_id في جدول posts)، يمكننا البدء في تعريف العلاقات في نماذج Eloquent.
الدرس الثاني: علاقة رأس بأطراف (One-to-Many) - الأساسية
هذه هي العلاقة الأكثر شيوعاً: المستخدم الواحد لديه عدة منشورات، ولكن المنشور الواحد يخص مستخدماً واحداً فقط [2].
الهدف: تعريف العلاقة بين نموذج User ونموذج Post.

1. تعريف العلاقة في نموذج User (الجانب "الواحد")
نحتاج إلى إخبار لارافيل أن المستخدم لديه "الكثير" من المنشورات. نستخدم الدالة hasMany():


// app/Models/User.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;
use Illuminate\Database\Eloquent\Relations\HasMany;

class User extends Authenticatable
{
    // ... (تأكد من وجود use HasFactory, Notifiable;)

    /**
     * Get the posts for the user.
     */
    public function posts(): HasMany // نحدد نوع العلاقة HasMany
    {
        return $this->hasMany(Post::class); // Post::class هو النموذج المرتبط
    }
}



2. تعريف العلاقة في نموذج Post (الجانب "الأطراف")
نحتاج إلى إخبار لارافيل أن المنشور "ينتمي إلى" مستخدم واحد فقط. نستخدم الدالة belongsTo():


// app/Models/Post.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Post extends Model
{
    use HasFactory;

    protected $fillable = ['title', 'body', 'user_id']; // للسماح بالتعبئة الجماعية

    /**
     * Get the user that owns the post.
     */
    public function user(): BelongsTo // نحدد نوع العلاقة BelongsTo
    {
        return $this->belongsTo(User::class); // User::class هو النموذج المرتبط
    }
}



الاختبار والتطبيق (مثال عملي وسؤال)
مثال تطبيقي:
كيف يمكننا الآن الوصول إلى بيانات العلاقة؟ لنفترض أن لديك مستخدم معرف في المتحكم (Controller):



// في أحد المتحكمات لديك
use App\Models\User;

$user = User::find(1);

// للحصول على جميع منشورات هذا المستخدم
foreach ($user->posts as $post) {
    echo $post->title . "<br>";
}

// للحصول على اسم المستخدم الذي يمتلك هذا المنشور (لو كان لديك Post object)
$post = Post::find(5);
echo $post->user->name; // الوصول المباشر لخاصية النموذج المرتبط





سؤال الدرس الأول:
لدينا علاقة رأس بأطراف (One-to-Many) أخرى: "دولة" و "مدينة".
ما اسم الدالة التي ستستخدمها في نموذج Country؟
ما اسم الدالة التي ستستخدمها في نموذج City؟
ما هو الحقل الذي يجب أن يكون موجوداً في جدول cities لربط العلاقة بشكل صحيح؟
أجب على السؤال أعلاه، وعندما تكون جاهزاً أو تحتاج إلى مساعدة، أخبرني لننتقل إلى الدرس التالي (علاقة رأس برأس) والمزيد من الأمثلة! [2, 1]


السؤال السابق (دولة/مدينة):
في نموذج Country: نستخدم hasMany().
في نموذج City: نستخدم belongsTo().
في جدول cities: يجب أن يكون حقل country_id



php artisan make:model Profile -m



// database/migrations/..._create_profiles_table.php

// ...
        Schema::create('profiles', function (Blueprint $table) {
            $table->id();
            $table->string('bio')->nullable();
            $table->string('website')->nullable();
            // المفتاح الخارجي (يجب أن يكون فريداً لأنها علاقة 1:1)
            $table->foreignId('user_id')->constrained()->unique();
            $table->timestamps();
        });
// ...



// app/Models/User.php

// ... (Imports)
use Illuminate\Database\Eloquent\Relations\HasOne;

class User extends Authenticatable
{
    // ...

    /**
     * Get the profile associated with the user.
     */
    public function profile(): HasOne
    {
        return $this->hasOne(Profile::class);
    }
}



// app/Models/Profile.php

// ... (Imports)
use Illuminate\Database\Eloquent\Relations\BelongsTo;

class Profile extends Model
{
    use HasFactory;

    protected $fillable = ['bio', 'website', 'user_id'];

    /**
     * Get the user that owns the profile.
     */
    public function user(): BelongsTo
    {
        return $this->belongsTo(User::class);
    }
}



$user = User::find(1);

// الوصول إلى بيانات الملف الشخصي مباشرةً
echo $user->profile->bio;
echo $user->profile->website;

// الوصول من الملف الشخصي إلى المستخدم
$profile = Profile::find(1);
echo $profile->user->name;
